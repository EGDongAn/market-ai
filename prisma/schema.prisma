generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model audit_logs {
  id          Int      @id @default(autoincrement())
  user_id     String?
  action      String
  entity_type String
  entity_id   Int?
  detail      Json?
  created_at  DateTime @default(now())
  users       users?   @relation(fields: [user_id], references: [id])
}

model brands {
  id               Int      @id @default(autoincrement())
  name             String   @unique
  name_en          String?
  manufacturer     String
  distributor      String?
  category         String
  official_url     String?
  product_page_url String?
  logo_url         String?
  description      String?
  is_active        Boolean  @default(true)
  created_at       DateTime @default(now())
  updated_at       DateTime
}

model company_settings {
  id                Int      @id @default(autoincrement())
  name              String
  business_number   String?
  representative    String?
  address           String?
  phone             String?
  fax               String?
  email             String?
  business_type     String?
  business_category String?
  created_at        DateTime @default(now())
  updated_at        DateTime
}

model contacts {
  id         Int      @id @default(autoincrement())
  partner_id Int
  name       String
  department String?
  position   String?
  phone      String?
  mobile     String?
  email      String?
  is_primary Boolean  @default(false)
  notes      String?
  created_at DateTime @default(now())
  updated_at DateTime
  partners   partners @relation(fields: [partner_id], references: [id], onDelete: Cascade)
  items      items[]
}

model invoice_hashes {
  id              Int       @id @default(autoincrement())
  hash            String    @unique
  partner_id      Int?
  invoice_date    DateTime? @db.Date
  total_amount    Decimal?  @db.Decimal(12, 2)
  item_count      Int
  raw_content     String?
  processed_at    DateTime  @default(now())
  transaction_ids String?
  partners        partners? @relation(fields: [partner_id], references: [id])
}

model item_barcodes {
  id            Int     @id @default(autoincrement())
  item_id       Int
  barcode_value String  @unique
  barcode_type  String?
  label         String?
  items         items   @relation(fields: [item_id], references: [id], onDelete: Cascade)
}

model item_lots {
  id                 Int                  @id @default(autoincrement())
  item_id            Int
  lot_number         String
  expiry_date        DateTime?            @db.Date
  initial_qty        Int
  current_qty        Int
  location_id        Int?
  created_at         DateTime             @default(now())
  items              items                @relation(fields: [item_id], references: [id], onDelete: Cascade)
  locations          locations?           @relation(fields: [location_id], references: [id])
  loan_items         loan_items[]
  stock_transactions stock_transactions[]

  @@unique([item_id, lot_number, location_id])
}

model item_matching_logs {
  id               Int      @id @default(autoincrement())
  partner_id       Int?
  input_name       String
  matched_item_id  Int?
  candidate_ids    Json?
  candidate_scores Json?
  match_method     String?
  confidence       Float?
  user_action      String?
  user_selection   Int?
  resolved         Boolean  @default(false)
  created_at       DateTime @default(now())

  @@index([partner_id])
  @@index([resolved])
}

model items {
  id                                                 Int                     @id @default(autoincrement())
  name                                               String
  category                                           String
  subcategory                                        String?
  brand                                              String?
  model                                              String?
  unit                                               String?
  storage_condition                                  String?
  description                                        String?
  image_url                                          String?
  created_at                                         DateTime                @default(now())
  updated_at                                         DateTime
  distributor                                        String?
  manufacturer                                       String?
  brand_en                                           String?
  category_en                                        String?
  distributor_en                                     String?
  manufacturer_en                                    String?
  name_en                                            String?
  subcategory_en                                     String?
  order_contact_name                                 String?
  order_contact_phone                                String?
  order_login_id                                     String?
  order_login_pw                                     String?
  order_method                                       String?
  order_website                                      String?
  usage_manual                                       String?
  aliases                                            Json?
  accessories                                        Json?
  packaging_desc                                     String?
  total_volume                                       Float?
  unit_type                                          String?
  unit_volume                                        Float?
  unit_volume_unit                                   String?
  units_per_box                                      Int?
  boxes_per_carton                                   Int?
  order_contact_id                                   Int?
  needs_order                                        Boolean?                @default(false)
  default_in_location_id                             Int?
  default_out_location_id                            Int?
  min_stock                                          Int?
  item_barcodes                                      item_barcodes[]
  item_lots                                          item_lots[]
  locations_items_default_in_location_idTolocations  locations?              @relation("items_default_in_location_idTolocations", fields: [default_in_location_id], references: [id])
  locations_items_default_out_location_idTolocations locations?              @relation("items_default_out_location_idTolocations", fields: [default_out_location_id], references: [id])
  contacts                                           contacts?               @relation(fields: [order_contact_id], references: [id])
  loan_items                                         loan_items[]
  partner_item_mappings                              partner_item_mappings[]
  stock_transactions                                 stock_transactions[]
}

model loan_items {
  id        Int        @id @default(autoincrement())
  loan_id   Int
  item_id   Int
  qty       Int
  lot_id    Int?
  items     items      @relation(fields: [item_id], references: [id], onDelete: Cascade)
  loans     loans      @relation(fields: [loan_id], references: [id], onDelete: Cascade)
  item_lots item_lots? @relation(fields: [lot_id], references: [id])
}

model loans {
  id              Int           @id @default(autoincrement())
  partner_id      Int
  direction       LoanDirection
  status          LoanStatus    @default(ONGOING)
  start_date      DateTime      @db.Date
  expected_return DateTime?     @db.Date
  actual_return   DateTime?     @db.Date
  note            String?
  created_at      DateTime      @default(now())
  loan_items      loan_items[]
  partners        partners      @relation(fields: [partner_id], references: [id], onDelete: Cascade)
}

model locations {
  id                                                                Int                  @id @default(autoincrement())
  code                                                              String               @unique
  name                                                              String
  type                                                              String
  parent_id                                                         Int?
  qr_value                                                          String
  is_active                                                         Boolean              @default(true)
  created_at                                                        DateTime             @default(now())
  item_lots                                                         item_lots[]
  items_items_default_in_location_idTolocations                     items[]              @relation("items_default_in_location_idTolocations")
  items_items_default_out_location_idTolocations                    items[]              @relation("items_default_out_location_idTolocations")
  locations                                                         locations?           @relation("locationsTolocations", fields: [parent_id], references: [id])
  other_locations                                                   locations[]          @relation("locationsTolocations")
  stock_transactions_stock_transactions_from_location_idTolocations stock_transactions[] @relation("stock_transactions_from_location_idTolocations")
  stock_transactions_stock_transactions_to_location_idTolocations   stock_transactions[] @relation("stock_transactions_to_location_idTolocations")
}

model manual_attachments {
  id         Int      @id @default(autoincrement())
  manual_id  Int
  file_name  String
  file_url   String
  file_size  Int?
  mime_type  String?
  created_at DateTime @default(now())
  manuals    manuals  @relation(fields: [manual_id], references: [id], onDelete: Cascade)

  @@index([manual_id])
}

model manual_categories {
  id                      Int                 @id @default(autoincrement())
  name                    String
  description             String?
  parent_id               Int?
  order                   Int                 @default(0)
  created_at              DateTime            @default(now())
  updated_at              DateTime
  manual_categories       manual_categories?  @relation("manual_categoriesTomanual_categories", fields: [parent_id], references: [id])
  other_manual_categories manual_categories[] @relation("manual_categoriesTomanual_categories")
  manuals                 manuals[]
}

model manual_tags {
  id      Int       @id @default(autoincrement())
  name    String    @unique
  manuals manuals[] @relation("manual_tagsTomanuals")
}

model manual_versions {
  id          Int      @id @default(autoincrement())
  manual_id   Int
  title       String
  content     String
  version     Int
  changed_by  String?
  change_note String?
  created_at  DateTime @default(now())
  manuals     manuals  @relation(fields: [manual_id], references: [id], onDelete: Cascade)

  @@index([manual_id])
}

model manuals {
  id                 Int                  @id @default(autoincrement())
  title              String
  content            String
  summary            String?
  category_id        Int?
  status             ManualStatus         @default(DRAFT)
  version            Int                  @default(1)
  view_count         Int                  @default(0)
  created_by         String?
  updated_by         String?
  created_at         DateTime             @default(now())
  updated_at         DateTime
  manual_attachments manual_attachments[]
  manual_versions    manual_versions[]
  manual_categories  manual_categories?   @relation(fields: [category_id], references: [id])
  manual_tags        manual_tags[]        @relation("manual_tagsTomanuals")

  @@index([category_id])
  @@index([status])
}

model partner_item_mappings {
  id                Int      @id @default(autoincrement())
  partner_id        Int
  item_id           Int
  partner_item_name String
  partner_item_code String?
  usage_count       Int      @default(1)
  confidence        Float    @default(1.0)
  source            String   @default("manual")
  created_at        DateTime @default(now())
  updated_at        DateTime
  items             items    @relation(fields: [item_id], references: [id], onDelete: Cascade)
  partners          partners @relation(fields: [partner_id], references: [id], onDelete: Cascade)

  @@unique([partner_id, partner_item_name])
  @@index([partner_id])
}

model partners {
  id                    Int                     @id @default(autoincrement())
  name                  String
  business_number       String?
  representative        String?
  address               String?
  phone                 String?
  type                  String?
  created_at            DateTime                @default(now())
  invoice_config        Json?
  invoice_history       Json?
  updated_at            DateTime                @default(now())
  contacts              contacts[]
  invoice_hashes        invoice_hashes[]
  loans                 loans[]
  partner_item_mappings partner_item_mappings[]
  stock_transactions    stock_transactions[]
}

model roles {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  created_at  DateTime @default(now())
  users       users[]
}

model stock_transactions {
  id                                                       Int         @id @default(autoincrement())
  item_id                                                  Int
  lot_id                                                   Int?
  type                                                     StockTxType
  qty                                                      Int
  from_location_id                                         Int?
  to_location_id                                           Int?
  performed_by                                             String?
  partner_id                                               Int?
  note                                                     String?
  created_at                                               DateTime    @default(now())
  locations_stock_transactions_from_location_idTolocations locations?  @relation("stock_transactions_from_location_idTolocations", fields: [from_location_id], references: [id])
  items                                                    items       @relation(fields: [item_id], references: [id], onDelete: Cascade)
  item_lots                                                item_lots?  @relation(fields: [lot_id], references: [id])
  partners                                                 partners?   @relation(fields: [partner_id], references: [id])
  users                                                    users?      @relation(fields: [performed_by], references: [id])
  locations_stock_transactions_to_location_idTolocations   locations?  @relation("stock_transactions_to_location_idTolocations", fields: [to_location_id], references: [id])
}

model users {
  id                 String               @id
  email              String               @unique
  name               String
  role_id            Int?
  created_at         DateTime             @default(now())
  audit_logs         audit_logs[]
  stock_transactions stock_transactions[]
  roles              roles?               @relation(fields: [role_id], references: [id])
}

model campaigns {
  id             Int              @id @default(autoincrement())
  name           String
  description    String?
  client_name    String
  client_contact String?
  start_date     DateTime
  end_date       DateTime?
  type           CampaignType     @default(COLLABORATION)
  budget         Decimal?         @db.Decimal(12, 0)
  status         CampaignStatus   @default(PLANNING)
  notes          String?
  created_at     DateTime         @default(now())
  updated_at     DateTime
  collaborations collaborations[]
}

model collaborations {
  id              Int                 @id @default(autoincrement())
  campaign_id     Int
  influencer_id   Int
  fee             Decimal?            @db.Decimal(12, 0)
  fee_type        FeeType             @default(FIXED)
  shooting_date   DateTime?
  progress_date   DateTime?
  upload_deadline DateTime?
  status          CollaborationStatus @default(CONTACTED)
  notes           String?
  created_at      DateTime            @default(now())
  updated_at      DateTime
  campaigns       campaigns           @relation(fields: [campaign_id], references: [id], onDelete: Cascade)
  influencers     influencers         @relation(fields: [influencer_id], references: [id], onDelete: Cascade)
  inf_contents    inf_contents[]

  @@unique([campaign_id, influencer_id])
}

model inf_channels {
  id             Int            @id @default(autoincrement())
  influencer_id  Int
  platform       InfPlatform
  handle         String
  url            String?
  follower_count Int?
  created_at     DateTime       @default(now())
  updated_at     DateTime
  influencers    influencers    @relation(fields: [influencer_id], references: [id], onDelete: Cascade)
  inf_contents   inf_contents[]
}

model inf_contents {
  id                 Int            @id @default(autoincrement())
  collaboration_id   Int
  channel_id         Int
  title              String?
  url                String
  content_type       ContentType    @default(VIDEO)
  uploaded_at        DateTime?
  views              Int            @default(0)
  likes              Int            @default(0)
  comments           Int            @default(0)
  shares             Int            @default(0)
  metrics_updated_at DateTime?
  notes              String?
  created_at         DateTime       @default(now())
  updated_at         DateTime
  inf_channels       inf_channels   @relation(fields: [channel_id], references: [id], onDelete: Cascade)
  collaborations     collaborations @relation(fields: [collaboration_id], references: [id], onDelete: Cascade)
}

model influencers {
  id                Int              @id @default(autoincrement())
  name              String
  nickname          String?
  email             String?
  phone             String?
  profile_image_url String?
  tier              InfluencerTier   @default(SILVER)
  category          String[]
  notes             String?
  is_active         Boolean          @default(true)
  created_at        DateTime         @default(now())
  updated_at        DateTime
  collaborations    collaborations[]
  inf_channels      inf_channels[]
}

enum LoanDirection {
  OUT
  IN
}

enum LoanStatus {
  ONGOING
  RETURNED
  OVERDUE
}

enum ManualStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum StockTxType {
  IN
  OUT
  ADJUST
  LOAN_OUT
  LOAN_IN
  TRANSFER
}

enum CampaignStatus {
  PLANNING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CampaignType {
  COLLABORATION
  ADVERTISEMENT
  EVENT
  REVIEW
  OTHER_CAMPAIGN
}

enum CollaborationStatus {
  CONTACTED
  NEGOTIATING
  CONFIRMED
  SHOOTING_DONE
  PROGRESS_DONE
  UPLOADED
  COLLAB_COMPLETED
  COLLAB_CANCELLED
}

enum ContentType {
  VIDEO
  SHORTS
  IMAGE
  BLOG
  STORY
  OTHER_CONTENT
}

enum FeeType {
  FIXED
  PER_CONTENT
  REVENUE_SHARE
  BARTER
}

enum InfPlatform {
  YOUTUBE
  INSTAGRAM
  TIKTOK
  BLOG_NAVER
  BLOG_OTHER
  FACEBOOK
  TWITTER
  OTHER
}

enum InfluencerTier {
  VIP
  GOLD
  SILVER
  BRONZE
}

// ============================================
// Market AI Tables (market-ai)
// ============================================

model market_competitors {
  id             Int                     @id @default(autoincrement())
  name           String                  @unique
  website        String?
  region         String?
  type           String?
  is_active      Boolean                 @default(true)
  crawl_priority Int                     @default(5)
  created_at     DateTime                @default(now())
  updated_at     DateTime                @updatedAt
  prices         market_prices[]
  crawl_configs  market_crawl_configs[]
}

model market_procedure_categories {
  id            Int                             @id @default(autoincrement())
  name          String                          @unique
  created_at    DateTime                        @default(now())
  subcategories market_procedure_subcategories[]
}

model market_procedure_subcategories {
  id          Int                         @id @default(autoincrement())
  category_id Int
  category    market_procedure_categories @relation(fields: [category_id], references: [id], onDelete: Cascade)
  name        String
  created_at  DateTime                    @default(now())
  procedures  market_procedures[]
}

model market_procedures {
  id             Int                            @id @default(autoincrement())
  subcategory_id Int
  subcategory    market_procedure_subcategories @relation(fields: [subcategory_id], references: [id], onDelete: Cascade)
  name           String
  aliases        Json?
  brand          String?
  unit           String?
  created_at     DateTime                       @default(now())
  updated_at     DateTime                       @updatedAt
  prices         market_prices[]
  our_prices     market_our_prices[]
  package_items  market_package_procedures[]
  trends         market_procedure_trends[]
  embedding      market_procedure_embeddings?
}

model market_procedure_embeddings {
  id            Int               @id @default(autoincrement())
  procedure_id  Int               @unique
  procedure     market_procedures @relation(fields: [procedure_id], references: [id], onDelete: Cascade)
  embedding     Json              // Array of 768 floats stored as JSON
  content       String
  created_at    DateTime          @default(now())
  updated_at    DateTime          @updatedAt
}

model market_prices {
  id            Int                @id @default(autoincrement())
  competitor_id Int
  competitor    market_competitors @relation(fields: [competitor_id], references: [id], onDelete: Cascade)
  procedure_id  Int
  procedure     market_procedures  @relation(fields: [procedure_id], references: [id], onDelete: Cascade)
  regular_price Decimal?           @db.Decimal(12, 0)
  event_price   Decimal?           @db.Decimal(12, 0)
  source_url    String?
  source_type   String?
  crawled_at    DateTime
  created_at    DateTime           @default(now())
}

model market_our_prices {
  id            Int               @id @default(autoincrement())
  procedure_id  Int
  procedure     market_procedures @relation(fields: [procedure_id], references: [id], onDelete: Cascade)
  regular_price Decimal           @db.Decimal(12, 0)
  event_price   Decimal?          @db.Decimal(12, 0)
  cost_price    Decimal?          @db.Decimal(12, 0)
  valid_from    DateTime          @db.Date
  valid_to      DateTime?         @db.Date
  is_active     Boolean           @default(true)
  created_at    DateTime          @default(now())
  updated_at    DateTime          @updatedAt
}

model market_price_history {
  id             Int      @id @default(autoincrement())
  competitor_id  Int?
  procedure_id   Int
  price_type     String
  old_price      Decimal? @db.Decimal(12, 0)
  new_price      Decimal  @db.Decimal(12, 0)
  change_percent Float?
  changed_at     DateTime
}

model market_packages {
  id            Int                         @id @default(autoincrement())
  name          String
  description   String?
  total_price   Decimal                     @db.Decimal(12, 0)
  discount_rate Float?
  source        String                      @default("AI")
  ai_rationale  String?
  is_active     Boolean                     @default(true)
  created_at    DateTime                    @default(now())
  updated_at    DateTime                    @updatedAt
  procedures    market_package_procedures[]
}

model market_package_procedures {
  id           Int               @id @default(autoincrement())
  package_id   Int
  package      market_packages   @relation(fields: [package_id], references: [id], onDelete: Cascade)
  procedure_id Int
  procedure    market_procedures @relation(fields: [procedure_id], references: [id], onDelete: Cascade)
  quantity     Int               @default(1)
  unit_price   Decimal           @db.Decimal(12, 0)
}

model market_crawl_configs {
  id              Int                @id @default(autoincrement())
  competitor_id   Int
  competitor      market_competitors @relation(fields: [competitor_id], references: [id], onDelete: Cascade)
  crawl_type      String
  target_url      String
  schedule        String?
  frequency       String             @default("DAILY")
  is_active       Boolean            @default(true)
  last_crawled_at DateTime?
  created_at      DateTime           @default(now())
}

model market_crawl_logs {
  id            Int       @id @default(autoincrement())
  competitor_id Int?
  status        String
  target_url    String
  items_found   Int       @default(0)
  items_updated Int       @default(0)
  error_message String?
  duration      Int?
  started_at    DateTime
  completed_at  DateTime?
}

model market_alerts {
  id             Int                          @id @default(autoincrement())
  name           String
  alert_type     String
  competitor_id  Int?
  procedure_id   Int?
  threshold      Float?
  threshold_type String?
  notify_email   String?
  is_active      Boolean                      @default(true)
  created_at     DateTime                     @default(now())
  notifications  market_alert_notifications[]
}

model market_alert_notifications {
  id       Int           @id @default(autoincrement())
  alert_id Int
  alert    market_alerts @relation(fields: [alert_id], references: [id], onDelete: Cascade)
  title    String
  message  String
  data     Json?
  is_read  Boolean       @default(false)
  sent_at  DateTime      @default(now())
}

model market_procedure_trends {
  id               Int               @id @default(autoincrement())
  procedure_id     Int
  procedure        market_procedures @relation(fields: [procedure_id], references: [id], onDelete: Cascade)
  period           String
  period_date      DateTime          @db.Date
  avg_price        Decimal?          @db.Decimal(12, 0)
  min_price        Decimal?          @db.Decimal(12, 0)
  max_price        Decimal?          @db.Decimal(12, 0)
  price_change     Float?
  competitor_count Int?

  @@unique([procedure_id, period, period_date])
}
