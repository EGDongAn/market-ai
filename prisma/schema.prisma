generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["common", "market"]
}

model audit_logs {
  id          Int      @id @default(autoincrement())
  user_id     String?
  action      String
  entity_type String
  entity_id   Int?
  detail      Json?
  created_at  DateTime @default(now())
  users       users?   @relation(fields: [user_id], references: [id])

  @@schema("common")
}

model company_settings {
  id                Int      @id @default(autoincrement())
  name              String
  business_number   String?
  representative    String?
  address           String?
  phone             String?
  fax               String?
  email             String?
  business_type     String?
  business_category String?
  created_at        DateTime @default(now())
  updated_at        DateTime

  @@schema("common")
}

model roles {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  created_at  DateTime @default(now())
  users       users[]

  @@schema("common")
}

model users {
  id         String       @id
  email      String       @unique
  name       String
  role_id    Int?
  created_at DateTime     @default(now())
  audit_logs audit_logs[]
  roles      roles?       @relation(fields: [role_id], references: [id])

  @@schema("common")
}

model market_alert_history {
  id             Int           @id @default(autoincrement())
  alert_id       Int
  triggered_at   DateTime?     @default(now()) @db.Timestamp(6)
  old_value      Decimal?      @db.Decimal(12, 2)
  new_value      Decimal?      @db.Decimal(12, 2)
  change_percent Decimal?      @db.Decimal(5, 2)
  message        String?
  is_read        Boolean?      @default(false)
  market_alerts  market_alerts @relation(fields: [alert_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([alert_id], map: "idx_market_alert_history_alert")
  @@schema("market")
}

model market_alerts {
  id                   Int                    @id @default(autoincrement())
  alert_type           String                 @db.VarChar(50)
  procedure_id         Int?
  competitor_id        Int?
  threshold_percent    Decimal?               @db.Decimal(5, 2)
  threshold_value      Decimal?               @db.Decimal(12, 2)
  is_active            Boolean?               @default(true)
  email_notify         Boolean?               @default(true)
  push_notify          Boolean?               @default(false)
  created_at           DateTime?              @default(now()) @db.Timestamp(6)
  updated_at           DateTime?              @default(now()) @db.Timestamp(6)
  market_alert_history market_alert_history[]
  market_competitors   market_competitors?    @relation(fields: [competitor_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  market_procedures    market_procedures?     @relation(fields: [procedure_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@schema("market")
}

model market_competitors {
  id                   Int                    @id @default(autoincrement())
  name                 String                 @unique @db.VarChar(255)
  website              String?
  region               String?                @db.VarChar(100)
  type                 String?                @db.VarChar(50)
  is_active            Boolean?               @default(true)
  crawl_priority       Int?                   @default(5)
  crawl_config         Json?
  last_crawled_at      DateTime?              @db.Timestamp(6)
  created_at           DateTime?              @default(now()) @db.Timestamp(6)
  updated_at           DateTime?              @default(now()) @db.Timestamp(6)
  market_alerts        market_alerts[]
  market_crawl_configs market_crawl_configs[]
  market_prices        market_prices[]

  @@schema("market")
}

model market_crawl_configs {
  id                 Int                @id @default(autoincrement())
  competitor_id      Int
  config_type        String             @db.VarChar(50)
  selectors          Json?
  schedule           String?            @db.VarChar(100)
  is_active          Boolean?           @default(true)
  last_run_at        DateTime?          @db.Timestamp(6)
  last_run_status    String?            @db.VarChar(20)
  created_at         DateTime?          @default(now()) @db.Timestamp(6)
  updated_at         DateTime?          @default(now()) @db.Timestamp(6)
  market_competitors market_competitors @relation(fields: [competitor_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("market")
}

model market_our_prices {
  id                Int               @id @default(autoincrement())
  procedure_id      Int
  regular_price     Decimal?          @db.Decimal(12, 2)
  event_price       Decimal?          @db.Decimal(12, 2)
  cost_price        Decimal?          @db.Decimal(12, 2)
  target_margin     Decimal?          @db.Decimal(5, 2)
  is_active         Boolean?          @default(true)
  valid_from        DateTime?         @db.Timestamp(6)
  valid_until       DateTime?         @db.Timestamp(6)
  created_at        DateTime?         @default(now()) @db.Timestamp(6)
  updated_at        DateTime?         @default(now()) @db.Timestamp(6)
  market_procedures market_procedures @relation(fields: [procedure_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("market")
}

model market_package_items {
  id                Int               @id @default(autoincrement())
  package_id        Int
  procedure_id      Int
  quantity          Int?              @default(1)
  discount_percent  Decimal?          @default(0) @db.Decimal(5, 2)
  created_at        DateTime?         @default(now()) @db.Timestamp(6)
  market_packages   market_packages   @relation(fields: [package_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  market_procedures market_procedures @relation(fields: [procedure_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("market")
}

model market_packages {
  id                   Int                    @id @default(autoincrement())
  name                 String                 @db.VarChar(255)
  description          String?
  regular_price        Decimal?               @db.Decimal(12, 2)
  package_price        Decimal?               @db.Decimal(12, 2)
  is_ai_suggested      Boolean?               @default(false)
  ai_rationale         String?
  is_active            Boolean?               @default(true)
  created_at           DateTime?              @default(now()) @db.Timestamp(6)
  updated_at           DateTime?              @default(now()) @db.Timestamp(6)
  market_package_items market_package_items[]

  @@schema("market")
}

model market_prices {
  id                 Int                @id @default(autoincrement())
  competitor_id      Int
  procedure_id       Int
  regular_price      Decimal?           @db.Decimal(12, 2)
  event_price        Decimal?           @db.Decimal(12, 2)
  unit_count         Int?               @default(1)
  source_url         String?
  crawled_at         DateTime?          @default(now()) @db.Timestamp(6)
  created_at         DateTime?          @default(now()) @db.Timestamp(6)
  market_competitors market_competitors @relation(fields: [competitor_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  market_procedures  market_procedures  @relation(fields: [procedure_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([competitor_id], map: "idx_market_prices_competitor")
  @@index([crawled_at], map: "idx_market_prices_crawled_at")
  @@index([procedure_id], map: "idx_market_prices_procedure")
  @@schema("market")
}

model market_procedure_categories {
  id                             Int                              @id @default(autoincrement())
  name                           String                           @unique @db.VarChar(100)
  description                    String?
  sort_order                     Int?                             @default(0)
  is_active                      Boolean?                         @default(true)
  created_at                     DateTime?                        @default(now()) @db.Timestamp(6)
  updated_at                     DateTime?                        @default(now()) @db.Timestamp(6)
  market_procedure_subcategories market_procedure_subcategories[]

  @@schema("market")
}

model market_procedure_embeddings {
  id                Int               @id @default(autoincrement())
  procedure_id      Int               @unique
  embedding         Json
  content           String?
  created_at        DateTime?         @default(now()) @db.Timestamp(6)
  updated_at        DateTime?         @default(now()) @db.Timestamp(6)
  market_procedures market_procedures @relation(fields: [procedure_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("market")
}

model market_procedure_subcategories {
  id                          Int                         @id @default(autoincrement())
  category_id                 Int
  name                        String                      @db.VarChar(100)
  description                 String?
  sort_order                  Int?                        @default(0)
  is_active                   Boolean?                    @default(true)
  created_at                  DateTime?                   @default(now()) @db.Timestamp(6)
  updated_at                  DateTime?                   @default(now()) @db.Timestamp(6)
  market_procedure_categories market_procedure_categories @relation(fields: [category_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  market_procedures           market_procedures[]

  @@unique([category_id, name])
  @@schema("market")
}

model market_procedures {
  id                             Int                             @id @default(autoincrement())
  name                           String                          @db.VarChar(255)
  subcategory_id                 Int?
  aliases                        String[]
  brand                          String?                         @db.VarChar(100)
  unit                           String?                         @db.VarChar(50)
  description                    String?
  is_active                      Boolean?                        @default(true)
  created_at                     DateTime?                       @default(now()) @db.Timestamp(6)
  updated_at                     DateTime?                       @default(now()) @db.Timestamp(6)
  market_alerts                  market_alerts[]
  market_our_prices              market_our_prices[]
  market_package_items           market_package_items[]
  market_prices                  market_prices[]
  market_procedure_embeddings    market_procedure_embeddings?
  market_procedure_subcategories market_procedure_subcategories? @relation(fields: [subcategory_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([subcategory_id], map: "idx_market_procedures_subcategory")
  @@schema("market")
}
